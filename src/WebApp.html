<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Email Agent Dashboard</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .main-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        /* Touch-optimized buttons - 56px height per iOS/Android standards */
        .btn-touch {
            height: 56px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            width: 100%;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .btn-primary-touch {
            background-color: #007AFF;
            color: white;
        }

        .btn-primary-touch:hover:not(:disabled) {
            background-color: #0056CC;
            transform: translateY(-1px);
        }

        .btn-success-touch {
            background-color: #28A745;
            color: white;
        }

        .btn-success-touch:hover:not(:disabled) {
            background-color: #1e7e34;
            transform: translateY(-1px);
        }

        .btn-touch:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Content area */
        .content-area {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.1);
            min-height: 200px;
        }

        .summary-content {
            line-height: 1.6;
            font-size: 15px;
            color: #333;
        }

        .summary-content h1,
        .summary-content h2,
        .summary-content h3 {
            color: #007AFF;
            font-weight: 600;
        }

        .summary-content h1 {
            font-size: 20px;
            margin: 30px 0 20px 0;
        }

        .summary-content h2 {
            font-size: 18px;
            margin: 25px 0 15px 0;
        }

        .summary-content h3 {
            font-size: 16px;
            margin: 20px 0 10px 0;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }

        .summary-content a {
            color: #007AFF;
            text-decoration: none;
            border-bottom: 1px solid #007AFF;
        }

        .summary-content a:hover {
            background-color: rgba(0, 122, 255, 0.1);
            text-decoration: none;
        }

        .summary-content strong {
            color: #007AFF;
        }

        .summary-content em {
            font-style: italic;
            color: #666;
        }

        .summary-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .summary-content li {
            margin: 5px 0;
        }

        .email-links {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .email-links h6 {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .email-link {
            display: block;
            color: #007AFF;
            text-decoration: none;
            padding: 8px 12px;
            margin: 4px 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .email-link:hover {
            background: #e9ecef;
            text-decoration: none;
            color: #0056CC;
        }

        /* Status messages */
        .status-message {
            padding: 16px;
            border-radius: 12px;
            margin: 16px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .status-loading {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .status-info {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #e1bee7;
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats display */
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 16px 0;
            font-size: 12px;
            color: #666;
        }

        .hidden {
            display: none !important;
        }

        /* iOS-style haptic feedback simulation */
        .btn-touch:active {
            transform: scale(0.98);
        }

        /* Enhanced mobile optimization */
        @media screen and (max-width: 480px) {
            .main-container {
                padding: 16px;
                max-width: 100%;
            }

            .header h1 {
                font-size: 18px;
            }

            .content-area {
                padding: 20px;
                margin: 16px 0;
            }

            .btn-touch {
                height: 60px; /* Slightly larger for small screens */
                font-size: 17px;
            }
        }

        /* Enhanced touch interaction */
        .btn-touch:focus {
            outline: 3px solid rgba(0, 122, 255, 0.5);
            outline-offset: 2px;
        }

        /* Improved status message styling */
        .status-message {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced error state styling */
        .status-error {
            border-left: 4px solid #dc3545;
        }

        .status-success {
            border-left: 4px solid #28a745;
        }

        .status-loading {
            border-left: 4px solid #007bff;
        }

        .status-info {
            border-left: 4px solid #6f42c1;
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            .btn-touch {
                transition: none;
            }

            .btn-touch:hover:not(:disabled) {
                transform: none;
            }

            .spinner {
                animation: none;
            }

            .status-message {
                animation: none;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn-primary-touch {
                border: 2px solid #000;
            }

            .btn-success-touch {
                border: 2px solid #000;
            }

            .status-message {
                border: 2px solid;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #000;
                color: #fff;
            }

            .content-area {
                background: #1c1c1e;
                color: #fff;
            }

            .email-link {
                background: #2c2c2e;
                color: #007AFF;
            }

            .email-link:hover {
                background: #3a3a3c;
            }

            .summary-content h1,
            .summary-content h2,
            .summary-content h3 {
                color: #007AFF;
            }

            .summary-content h3 {
                border-bottom-color: #3a3a3c;
            }

            .summary-content a {
                color: #007AFF;
                border-bottom-color: #007AFF;
            }

            .summary-content a:hover {
                background-color: rgba(0, 122, 255, 0.2);
            }

            .summary-content em {
                color: #ccc;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>Email Dashboard</h1>
            <p>On-demand email summarization and archiving</p>
        </div>

        <!-- Primary Action Button -->
        <button id="getSummaryBtn" class="btn-touch btn-primary-touch" onclick="getSummary()">
            <span id="getSummaryText">Get Summary</span>
        </button>

        <!-- Status Messages -->
        <div id="statusMessage" class="hidden"></div>

        <!-- Content Area -->
        <div id="contentArea" class="content-area hidden">
            <div id="summaryContent" class="summary-content"></div>
            <div id="emailLinks" class="email-links hidden"></div>
            <div id="stats" class="stats hidden"></div>
        </div>

        <!-- Archive Button (shown after summary) -->
        <button id="archiveBtn" class="btn-touch btn-success-touch hidden" onclick="archiveEmails()">
            <span id="archiveText">Archive Emails</span>
        </button>
    </div>

    <!-- Bootstrap 5 JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

    <script>
        let currentEmailCount = 0;
        let isProcessing = false;
        let retryCount = 0;
        const MAX_RETRIES = 2;

        function showStatus(message, type = 'loading', showRetry = false) {
            const statusEl = document.getElementById('statusMessage');
            const spinner = type === 'loading' ? '<span class="spinner"></span>' : '';
            const retryButton = showRetry ?
                `<br><button onclick="retrySummary()" style="margin-top: 8px; padding: 4px 12px; background: #007AFF; color: white; border: none; border-radius: 6px; cursor: pointer;">Try Again</button>` : '';

            statusEl.innerHTML = spinner + message + retryButton;
            statusEl.className = `status-message status-${type}`;
            statusEl.classList.remove('hidden');
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.add('hidden');
        }

        function showDetailedError(errorType, details) {
            let message = '';
            let showRetry = false;

            switch (errorType) {
                case 'network':
                    message = 'Network connection issue. Please check your internet connection and try again.';
                    showRetry = true;
                    break;
                case 'quota':
                    message = 'Daily AI quota exceeded. Please try again tomorrow or contact your administrator.';
                    break;
                case 'permission':
                    message = 'Permission denied. Please refresh the page and re-authorize the app.';
                    showRetry = true;
                    break;
                case 'timeout':
                    message = 'Request timed out. This may happen with large email batches. Try reducing the number of emails or try again.';
                    showRetry = true;
                    break;
                case 'disabled':
                    message = 'Web app functionality is currently disabled. Please contact your administrator.';
                    break;
                default:
                    message = `Error: ${details}`;
                    showRetry = retryCount < MAX_RETRIES;
            }

            showStatus(message, 'error', showRetry);
        }

        function categorizeError(errorMessage) {
            const error = errorMessage.toLowerCase();

            if (error.includes('network') || error.includes('connection') || error.includes('fetch')) {
                return 'network';
            }
            if (error.includes('quota') || error.includes('budget') || error.includes('limit')) {
                return 'quota';
            }
            if (error.includes('permission') || error.includes('authorization') || error.includes('auth')) {
                return 'permission';
            }
            if (error.includes('timeout') || error.includes('time out')) {
                return 'timeout';
            }
            if (error.includes('disabled') || error.includes('not enabled')) {
                return 'disabled';
            }
            return 'generic';
        }

        function updateButtonState(button, disabled, text) {
            button.disabled = disabled;
            const textEl = button.querySelector('span');
            if (textEl) textEl.textContent = text;
        }

        function showContent(summaryData) {
            const contentArea = document.getElementById('contentArea');
            const summaryContent = document.getElementById('summaryContent');
            const emailLinks = document.getElementById('emailLinks');
            const stats = document.getElementById('stats');
            const archiveBtn = document.getElementById('archiveBtn');
            const archiveText = document.getElementById('archiveText');

            // Comprehensive markdown-to-HTML renderer
            function renderMarkdownToHtml(markdownText) {
                let html = markdownText;

                // Convert headers (### format)
                html = html.replace(/^### (.+)$/gm, '<h3 style="color: #007AFF; font-size: 16px; font-weight: 600; margin: 20px 0 10px 0; border-bottom: 2px solid #e9ecef; padding-bottom: 5px;">$1</h3>');

                // Convert headers (## format)
                html = html.replace(/^## (.+)$/gm, '<h2 style="color: #007AFF; font-size: 18px; font-weight: 600; margin: 25px 0 15px 0;">$1</h2>');

                // Convert headers (# format)
                html = html.replace(/^# (.+)$/gm, '<h1 style="color: #007AFF; font-size: 20px; font-weight: 600; margin: 30px 0 20px 0;">$1</h1>');

                // Convert bold text
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #007AFF;">$1</strong>');

                // Convert italic text
                html = html.replace(/\*(.*?)\*/g, '<em style="font-style: italic;">$1</em>');

                // Convert markdown links to HTML with proper styling
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #007AFF; text-decoration: none; border-bottom: 1px solid #007AFF;">$1</a>');

                // Convert line breaks to HTML
                html = html.replace(/\n/g, '<br>');

                // Convert bullet lists (simple implementation)
                html = html.replace(/^- (.+)$/gm, '<li style="margin: 5px 0;">$1</li>');
                html = html.replace(/(<li.*<\/li>)/s, '<ul style="margin: 10px 0; padding-left: 20px;">$1</ul>');

                return html;
            }

            // Display the AI-generated summary with comprehensive markdown rendering
            const formattedSummary = renderMarkdownToHtml(summaryData.summary);
            summaryContent.innerHTML = formattedSummary;

            // Email links are now integrated within the summary themes, so no separate section needed

            // Show stats
            stats.innerHTML = `
                <span>Processed: ${summaryData.processedCount || summaryData.emailCount}</span>
                <span>Found: ${summaryData.totalFound || summaryData.emailCount}</span>
            `;
            stats.classList.remove('hidden');

            // Update archive button with exact count
            currentEmailCount = summaryData.emailCount;
            const emailText = currentEmailCount === 1 ? 'Email' : 'Emails';
            archiveText.textContent = `Archive ${currentEmailCount} ${emailText}`;

            // Show content and archive button
            contentArea.classList.remove('hidden');
            archiveBtn.classList.remove('hidden');
        }

        function clearContent() {
            document.getElementById('contentArea').classList.add('hidden');
            document.getElementById('archiveBtn').classList.add('hidden');
            document.getElementById('emailLinks').classList.add('hidden');
            document.getElementById('stats').classList.add('hidden');
            currentEmailCount = 0;
        }

        function getSummary() {
            if (isProcessing) return;

            isProcessing = true;
            clearContent();

            const getSummaryBtn = document.getElementById('getSummaryBtn');
            updateButtonState(getSummaryBtn, true, 'Processing...');
            showStatus('Scanning emails with "summarize" label...', 'loading');

            // Add connection check
            if (!navigator.onLine) {
                isProcessing = false;
                updateButtonState(getSummaryBtn, false, 'Get Summary');
                showDetailedError('network', 'No internet connection detected');
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    isProcessing = false;
                    retryCount = 0; // Reset retry count on success
                    updateButtonState(getSummaryBtn, false, 'Get Summary');

                    if (!response.success) {
                        const errorType = categorizeError(response.error || '');
                        showDetailedError(errorType, response.error);
                        return;
                    }

                    if (response.emailCount === 0) {
                        showStatus(response.message ||
                            'No emails found with "summarize" label. Apply the label to some emails in Gmail first.', 'info');
                        return;
                    }

                    showStatus(`Found ${response.emailCount} emails. Generated summary successfully!`, 'success');
                    showContent(response);

                    // Auto-hide success message after 3 seconds
                    setTimeout(hideStatus, 3000);
                })
                .withFailureHandler(function(error) {
                    isProcessing = false;
                    updateButtonState(getSummaryBtn, false, 'Get Summary');

                    const errorType = categorizeError(error.toString());
                    showDetailedError(errorType, error.toString());

                    retryCount++;
                })
                .summarizeEmails();
        }

        function retrySummary() {
            if (retryCount < MAX_RETRIES) {
                hideStatus();
                setTimeout(getSummary, 1000); // Wait 1 second before retry
            }
        }

        function archiveEmails() {
            if (isProcessing || currentEmailCount === 0) return;

            const emailText = currentEmailCount === 1 ? 'email' : 'emails';
            if (!confirm(`Archive ${currentEmailCount} ${emailText}?\n\nThis will:\n• Move emails to Archive folder\n• Keep the "summarize" label for future processing\n• Clear the current summary\n\nThis action cannot be undone.`)) {
                return;
            }

            // Connection check
            if (!navigator.onLine) {
                showDetailedError('network', 'No internet connection detected');
                return;
            }

            isProcessing = true;
            const archiveBtn = document.getElementById('archiveBtn');
            updateButtonState(archiveBtn, true, 'Archiving...');
            showStatus(`Archiving ${currentEmailCount} ${emailText}...`, 'loading');

            google.script.run
                .withSuccessHandler(function(response) {
                    isProcessing = false;
                    updateButtonState(archiveBtn, false, 'Archive Emails');

                    if (!response.success) {
                        const errorType = categorizeError(response.error || '');
                        showDetailedError(errorType, response.error);
                        return;
                    }

                    // Enhanced success feedback
                    const archivedCount = response.archivedCount || currentEmailCount;
                    const successMessage = archivedCount === currentEmailCount ?
                        `Successfully archived ${archivedCount} ${emailText}` :
                        `Archived ${archivedCount} of ${currentEmailCount} ${emailText}. Some emails may have already been processed.`;

                    showStatus(successMessage, 'success');
                    clearContent();

                    // Auto-hide success message after 4 seconds (longer for archive confirmation)
                    setTimeout(hideStatus, 4000);
                })
                .withFailureHandler(function(error) {
                    isProcessing = false;
                    updateButtonState(archiveBtn, false, 'Archive Emails');

                    const errorType = categorizeError(error.toString());
                    showDetailedError(errorType, error.toString());
                })
                .archiveProcessedEmails();
        }

        // Network connectivity monitoring
        function checkConnectivity() {
            if (!navigator.onLine) {
                showStatus('You are currently offline. Some features may not work.', 'error');
            }
        }

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            // Check initial connectivity
            if (navigator.onLine) {
                showStatus('Ready to process emails', 'success');
                setTimeout(hideStatus, 2000);
            } else {
                showStatus('You are currently offline. Please check your internet connection.', 'error');
            }

            // Add connectivity listeners
            window.addEventListener('online', function() {
                showStatus('Connection restored. You can now process emails.', 'success');
                setTimeout(hideStatus, 3000);
            });

            window.addEventListener('offline', function() {
                showStatus('You are now offline. Some features may not work.', 'error');
            });
        });

        // Enhanced keyboard shortcuts for accessibility
        document.addEventListener('keydown', function(e) {
            // Enter key on buttons
            if (e.key === 'Enter' && e.target.tagName === 'BUTTON') {
                e.target.click();
            }

            // Escape key to cancel/hide status
            if (e.key === 'Escape') {
                if (!isProcessing) {
                    hideStatus();
                }
            }

            // Keyboard shortcuts (with Ctrl/Cmd)
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        if (!isProcessing) {
                            getSummary();
                        }
                        break;
                    case 'a':
                        e.preventDefault();
                        if (!isProcessing && currentEmailCount > 0) {
                            archiveEmails();
                        }
                        break;
                }
            }
        });

        // Enhanced error logging for debugging
        window.addEventListener('error', function(e) {
            console.error('Web App Error:', e.error);
            if (!isProcessing) {
                showStatus('An unexpected error occurred. Please refresh the page and try again.', 'error');
            }
        });

        // Add focus management for better accessibility
        function manageFocus() {
            const getSummaryBtn = document.getElementById('getSummaryBtn');
            const archiveBtn = document.getElementById('archiveBtn');

            if (!archiveBtn.classList.contains('hidden')) {
                archiveBtn.focus();
            } else {
                getSummaryBtn.focus();
            }
        }
    </script>
</body>
</html>